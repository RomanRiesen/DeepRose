<html>

<!--
Copyright Roman Riesen 2016-2017

License:
    Do wathever you want. Just keep this comment in this file.
 -->

 <!--
DISCLAIMER:

 Many, many, many things are quick and dirty.

 Probably not going to clean it up. Since it works as it is (I think at least).
  -->

<script src="Card.js"></script>
<script src="Deck.js"></script>
<script src="Player.js"></script>
<script src="Board.js"></script>
<script src="Polynomials.js"></script>
<script src="MinMax.js"></script>
<script src="SaveAndLoad.js"></script>
<script src="backgroundTest.js"></script>
<script src="ColorScheme.js"></script>

<link rel="stylesheet" type="text/css" href="style.css">
<link rel="ICON"href="DeepRose.png">

<title>Rosenk&ouml;nig</title>

<body style = "width:100%; text-align:center;">


    <!--<table style="position:absolute;top:18%;bottom:18%;width:100%; text-align: center;">-->

    <table id = "game" style="position:absolute;width:100%;height:100%;text-align: center;">
        <tr>
            <td>
                <canvas id="player1allignmentCanvas" class = "left" width="100" height="100"></canvas>
            </td>
            <td>
                <canvas id="player1Canvas" class = "centerHor" width="600" height="100"></canvas>
            </td>
            <td>
                <canvas id="player1KnightCanvas" class = "right" width="100" height="100"></canvas>
            </td>
        </tr>

        <tr>
            <td style="">
                <canvas id="leftPanel" class = "left" width="100" height="600"></canvas>
            </td>
            <td style="width:4%; text-align: center;">
                <canvas id="BoardCanvas" class = "centerHor" width="600" height="600" >
                    Your browser does not support the HTML5 canvas tag.</canvas>
                </td>
                <td style="">
                    <canvas id="rightPanel" class = "right" width="100" height="600"></canvas>
                </td>
            </tr>

            <tr>
                <td>
                    <canvas id="player2KnightCanvas" class = "left" width="100" height="100"></canvas>
                </td>
                <td>
                    <canvas id="player2Canvas" class = "centerHor" width="600" height="100"></canvas>
                </td>
                <td>
                    <canvas id="player2allignmentCanvas" class = "right" width="100" height="100"></canvas>
                </td>
            </tr>
        </table>
        <!-- <canvas id = "background" style = "width:100%;height:100%;z-index:20;transform:translate(0,0)"></canvas> -->
    </body>
    <script>

    function getIndexesOfFieldAtCursor(event, border, boardSize){//FIXME put into board
        var canvas = document.getElementById("BoardCanvas")
        var rect = canvas.getBoundingClientRect()
        var y = event.clientY - rect.top
        var x = event.clientX - rect.left
        var fieldSizeX = (canvas.clientWidth/boardSize)-border
        var fieldSizeY = (canvas.clientHeight/boardSize)-border
        var xf = (x/(fieldSizeX+border))
        var yf = (y/(fieldSizeX+border))
        return {x:Math.floor(xf),y:Math.floor(yf)}
    }

    function tempAlert(msg,duration=1000)//FIXME replace text if div still exists
    {
        var el = document.createElement("div")
        // el.setAttribute("style","position:absolute;top:47%;left:30%;right:30%;font-size:36px;border-radius:5px;border-style:solid;border-width:5px;border-color:"+activePlayer.color2+";color:"+activePlayer.color2+";background-color:"+activePlayer.color)
        el.setAttribute("style","position:fixed;top:48%;bottom:bottom:48%;left:30%;right:30%;font-size:36px;color:"+activePlayer.color2+";background-color:"+/*activePlayer.color*/neutralColor+";border-style: solid;border-color:"+activePlayer.color2)
        //el.setAttribute("style","width:100%;color:white;background-color:"+activePlayer.color)
        el.innerHTML = msg
        setTimeout(function(){
            el.parentNode.removeChild(el)
        },duration)
        document.body.appendChild(el)
    }

    function dialogBox(msg,callback = function(){})//FIXME replace text if div still exists
    {
        dialogBoxActive = true
        var dB = document.createElement("div")
        dB.setAttribute("id","dialogBox")
        dB.setAttribute("style","position:fixed;top:43%;bottom:bottom:43%;left:30%;right:30%;font-size:36px;color:"+activePlayer.color2+";background-color:"+/*activePlayer.color*/neutralColor+";border-style: solid;border-color:"+activePlayer.color2)
        dB.innerHTML = msg+"<br><button style = \"background-color:"+activePlayer.color2+";color:"+activePlayer.color+"\">Ok.</button>"
        document.body.appendChild(dB)
        dB.addEventListener('mousedown',function(event){dB.parentNode.removeChild(dB); dialogBoxActive = false;callback()})
    }

    function aiOr2PlayerBox(callback = function(){})//FIXME replace text if div still exists
    {
        dialogBoxActive = true
        var dB = document.createElement("div")
        dB.setAttribute("id","dialogBox")
        dB.setAttribute("style","position:fixed;top:45%;bottom:bottom:43%;left:30%;right:30%;font-size:0px;color:"+/*activePlayer.color2*/neutralColor+";border:2px;background-color:"+neutralColor/*activePlayer.color*/+";border-style:solid;border-color:"+activePlayer.color2)
        //dB.innerHTML = "~~ Ai or not? ~~"
        dB.innerHTML = "<br><button onclick=\"window.againstAi = true;\" style = \"background-color:"+inactivePlayer.color2+";color:"+inactivePlayer.color+"\">Against Ai</button>"
        dB.innerHTML += "<br><button onclick=\"window.againstAi = false;\" style = \"background-color:"+activePlayer.color2+";color:"+activePlayer.color+"\">2 Player</button>"
        document.body.appendChild(dB)
        dB.addEventListener('mousedown',function(event){dB.parentNode.removeChild(dB); dialogBoxActive = false;callback()})
    }

    function fillInBackground(ctx,backgroundColor){
        ctx.clearRect(-100,-100,10000, 10000)
        ctx.beginPath()
        ctx.fillStyle = backgroundColor
        ctx.fillRect(-100,-100,10000,10000)//FIXME UGLY "HAcK"//get actual size
    }

    function getContextWithSizesAndCanvas(string){
        var canvas  = document.getElementById(string)
        var ctx     =  canvas.getContext("2d")
        ctx.width   =  canvas.width
        ctx.height  =  canvas.height
        return{"ctx":ctx,"canvas":canvas}
    }


    function getClickedCardIndex(canvas){
        var canvas = document.getElementById("player2Canvas")//!!! FIXME Detect when game has ended or one player is unable to play, so he has to pass.
        var rect = canvas.getBoundingClientRect()
        var x = event.clientX - rect.left
        var fieldSizeX = (canvas.clientWidth/player2.cards.length)
        return Math.floor(x/(fieldSizeX))
    }


    </script>

    <script>
    //FIXME function onwindowresize adjustElement(ctx, width, height){} and use the proper sizes, as in the link in the mail that I sent to myself (from mcs to gmx mail)



    var partitions = 7//In how many parts the display is split (cards will have a height of 1 part)
    var totHeight = window.innerHeight
    var totWidth = window.innerWidth
    var yUnit = totHeight/partitions
    var xUnit = totWidth/partitions
    //setting all the canvas sizes. Yey. Responsive!
    document.getElementById("BoardCanvas").width = Math.min((partitions-2)*xUnit, (partitions-2)*yUnit)//6*xUnit
    document.getElementById("BoardCanvas").height = Math.min((partitions-2)*xUnit, (partitions-2)*yUnit)//6*yUnit

    document.getElementById("player1Canvas").width = Math.min((partitions-2)*xUnit, (partitions-2)*yUnit)
    document.getElementById("player1Canvas").height = yUnit

    document.getElementById("player2Canvas").width = Math.min((partitions-2)*xUnit, (partitions-2)*yUnit)
    document.getElementById("player2Canvas").height = yUnit

    document.getElementById("player1allignmentCanvas").width = xUnit
    document.getElementById("player1allignmentCanvas").height = yUnit

    document.getElementById("player2allignmentCanvas").width =  xUnit
    document.getElementById("player2allignmentCanvas").height = yUnit

    document.getElementById("player1KnightCanvas").width = xUnit
    document.getElementById("player1KnightCanvas").height = yUnit

    document.getElementById("player2KnightCanvas").width = xUnit
    document.getElementById("player2KnightCanvas").height = yUnit

    document.getElementById("leftPanel").width = xUnit
    document.getElementById("leftPanel").height = (partitions-2)*yUnit

    document.getElementById("rightPanel").width = xUnit
    document.getElementById("rightPanel").height = (partitions-2)*yUnit

    window.LINEWIDTH = (xUnit+yUnit)/150

    window.TURNTIME = 900//Milliseconds of pause between player and ai

    var player1Field      = getContextWithSizesAndCanvas("player1Canvas").canvas//awful
    var player1FieldCtx   = getContextWithSizesAndCanvas("player1Canvas").ctx
    var player2Field      = getContextWithSizesAndCanvas("player2Canvas").canvas
    var player2FieldCtx   = getContextWithSizesAndCanvas("player2Canvas").ctx
    var player1Knights    = getContextWithSizesAndCanvas("player1KnightCanvas").canvas
    var player1KnightsCtx = getContextWithSizesAndCanvas("player1KnightCanvas").ctx
    var player2Knights    = getContextWithSizesAndCanvas("player2KnightCanvas").canvas
    var player2KnightsCtx = getContextWithSizesAndCanvas("player2KnightCanvas").ctx

    var player1PointsCtx  = getContextWithSizesAndCanvas("player1allignmentCanvas").ctx
    var player2PointsCtx  = getContextWithSizesAndCanvas("player2allignmentCanvas").ctx

    var leftPanel         = getContextWithSizesAndCanvas("leftPanel").canvas
    var leftPanelCtx      = getContextWithSizesAndCanvas("leftPanel").ctx
    var rightPanel        = getContextWithSizesAndCanvas("rightPanel").canvas
    var rightPanelCtx     = getContextWithSizesAndCanvas("rightPanel").ctx

    var c   = getContextWithSizesAndCanvas("BoardCanvas").canvas
    var ctx  = getContextWithSizesAndCanvas("BoardCanvas").ctx

    //createBackground()


    function setup () {}

    //FIXME should have a GAME object, that just basically has a reference to everything. Makes it also much easier to store and reload stuff.
    var boardSize = 9//9 or 11 works good.
    var border = 6

    var dialogBoxActive = false//FIXME TODO god beware, it's a global! and it should probably be solved differently
    window.againstAi = true


    //function locationHashChanged() {
    // FIXME use something like this to update the colors of the game: if (location.hash === "#irgendeinCoolesFeature") {}
    var clrShmeSelected = window.location.hash.split("c=")
    clrShmeSelected = clrShmeSelected[clrShmeSelected.length-1]
    console.log(clrShmeSelected);
    if(clrShmeSelected == ""){window.location.hash = "c=default"; clrShmeSelected = "default";}
    console.log(clrShmeSelected);
    var clrShme = colorSchemeDict[clrShmeSelected.toLowerCase()]
    
    var player1 = new Player(clrShme.player1color1,clrShme.player1color2 , "Player1", window.againstAi, player1FieldCtx, player1KnightsCtx, player1PointsCtx)
    var player2 = new Player(clrShme.player2color1,clrShme.player2color2 , "Player2", false, player2FieldCtx, player2KnightsCtx, player2PointsCtx)
    var neutralColor = clrShme.neutralColor
    var backgroundColor = clrShme.backgroundColor
    var fieldColor = clrShme.fieldColor
    var fieldBorderColor = clrShme.fieldBorderColor
    var crownColor = clrShme.crownColor
    document.body.style.backgroundImage = "url('"+clrShme.backgroundImage+"')"
    //Players are not allowed to have the same name since I count according to name and not object
    if(player1.name == player2.name){
        player1.name = player1.name+"1"
        player2.name = player1.name+"2"
    }

    var board = new Board(boardSize, crownColor,fieldColor,fieldBorderColor,backgroundColor)

    var deck = new Deck(leftPanelCtx)
    deck.shuffle()
    for (var i = 0; i < 5; i++) {//give inital cards//FIXME make this a player method
        player1.cards.push(deck.getTopCard())
        player2.cards.push(deck.getTopCard())
    }

    var activePlayer = player2
    var inactivePlayer = player1

    //Now I only have to set the activePlayer to the correct player.
    board.myDisplay = function(){board.display(ctx,rightPanelCtx,player1,player2,deck,activePlayer)}
    board.myDisplay()

    aiOr2PlayerBox()
    //tempAlert(activePlayer.name+" begins!")

    //var ai1 = new AI(player2,player1,3)
    if(window.againstAi){
        var ai2 = new AI(player1,player2,3)
    }
    var useKnight = false//used to keep track if player selected the use of knights

    //var gameState = new GameState(board,deck)


    var isAllowedToPlayCard = true
    var lastPlayerWasAbleToPlay = true

    var turn = 0

    var unableToPlaySince = 0

    var gameEnded = false

    function changeActivePlayer(){//FIMXE Need ai vs ai mode for dna training, Human vs Human and Ai vs Ai
        //Maybe do a function for all o them.
        // Or even a "Class"(-function).
        if(gameEnded){return}

        player1.isAi = window.againstAi

        activePlayer = activePlayer == player1? player2 : player1
        inactivePlayer = activePlayer == player1? player1 : player2

        if(board.remainingStones <= 0){//clearInterval(interval)
            console.log("The game has ended! by lack of stones to play\nin turn:", Math.floor(turn/2))
            finishGame()
        }

        var obj = activePlayer.checkPossibleMoves(board,deck)//FIXME DETAIL: find good name for this object, update Player.js to use the better name.
        //  Possible states
        //    "noPossibleTurnLeft"
        //    "hasToPlayKnight"
        //    "hasToTakeCard"
        //    "hasToTakeCardOrPlayKnight"
        //    "isAbleToPlayNormally"
        turn++
        var state = obj.state
        var indices = obj.playableIndices
        //console.log(state,indices,lastPlayerWasAbleToPlay);
        if(state == "noPossibleTurnLeft"){
            //player has full hand cards and is unable to play any of them even with a knight.
            //if(board.gameHasEnded(activePlayer.copy(),inactivePlayer.copy(),deck.copy())){
            tempAlert(activePlayer.name+" is not able to do any move!", 1000)
            if(inactivePlayer.checkPossibleMoves(board, deck).state == "noPossibleTurnLeft"){
                //both players are unable to play any cards
                //thus ends the game.//GAME ENDS TOO EARLY.
                //finishGame()
                board.myDisplay()
                console.log("Game should have ended");
                if(unableToPlaySince > 2){
                    board.myDisplay()
                    finishGame()
                }
                unableToPlaySince++
                changeActivePlayer()
            }
            else{
                board.myDisplay()
                lastPlayerWasAbleToPlay = false
                changeActivePlayer()
            }
        }
        if(state == "hasToPlayKnight"){//FIXME Give visual clues to these states by defocusing/overlaying/transparancy of cards.
            isAllowedToPlayCard = false
        }
        if(state == "hasToTakeCard" && !activePlayer.isAi){
            //dialogBox(activePlayer.name+" has to draw a card.")//" Card has been drawn.")
            //activePlayer.addCard(deck)
            //isAllowedToPlayCard = false
            //changeActivePlayer()
        }
        if(state == "hasToTakeCardOrPlayKnight"){
            isAllowedToPlayCard = false
        }

        lastPlayerWasAbleToPlay = true
        isAllowedToPlayCard = true

        unableToPlaySince = 0
        //tempAlert("Now it is "+activePlayer.name+"'s turn!")
        //dialogBox("Now it is "+activePlayer.name+"'s turn!")

        //TODO FIXME ONLY TEST CODE (As quite the lot in here.)
        board.myDisplay()
        if(activePlayer.isAi === true){
            ai2.playBestNextTurn(board, deck)
            setTimeout(function(){
                board.myDisplay()
                changeActivePlayer()
            }, window.TURNTIME)
        }
    }

    function finishGame(){

        var string = ""

        if(board.remainingStones < 1){
            string += "There aren't any stones left.<br>"
        }

        var p1Score = player1.countScore(board, deck)
        var p2Score = player2.countScore(board, deck)

        if(p1Score > p2Score){
            activePlayer = player1//so board and message colours match the winner colours.
        }else{
            activePlayer = player2
        }
        string += activePlayer.name

        string += " won!"


        //console.log("Game has ended")
        //dialogBox("THE GAME HAS ENDED<br>AND "+ winner + " WON!")
        dialogBox(string)
        board.myDisplay()
        gameEnded = true
    }

    //------------------------------------------------------------------------------

    //Random random AI game:
    // ai = ai1
    // for(var i = 0; i < 100; i++){
    //     ai = ai == ai1 ? ai2 : ai1
    //     ai.playBestNextTurn(board, deck)
    // }
    // board.myDisplay()


    var currKonamiIndex = 0
    var konamiCode = ["ArrowUp", "ArrowUp", "ArrowDown", "ArrowDown", "ArrowLeft", "ArrowRight", "ArrowLeft", "ArrowRight", "KeyB", "KeyA"]
    document.addEventListener("keydown", function(key){
        //console.log(currKonamiIndex);
        if(konamiCode[currKonamiIndex] == key.code){
            currKonamiIndex++
            console.log(currKonamiIndex)
            if(currKonamiIndex == konamiCode.length){
                tempAlert("#HACKS", 200)
                //activePlayer.additionalPoints += 5+Math.round(30*Math.random())
                activePlayer.knightCount = 5
                //Give player 10 cards or something?
                window.TURNTIME = 200
                while(activePlayer.addCard(deck) === true){}
                console.log("EVIL CHEATER!");
                board.myDisplay()
            }
        }
        else{currKonamiIndex = 0}
    })




    // //Mouse interaction:
    // document.getElementById("BoardCanvas").addEventListener('mousedown',function(event){
    //   var pos = getIndexesOfFieldAtCursor(event, border, boardSize)
    //   pos0 = board.crownPosition
    //   board.fields[pos.x][pos.y].owner = activePlayer//FIXME put display and ownage reassignment into 1 fucntion, but into board
    //   board.displayAt(ctx,pos.x,pos.y,activePlayer)
    //   board.displayAt(ctx,pos0.x,pos0.y,board.fields[pos0.x][pos0.y].owner)
    //   board.setCrownPosition(ctx,pos.x,pos.y)
    //   console.log("next turn")
    //   //console.log(player1.countConnected(pos.x,pos.y,board))
    //   //turn()
    //   changeActivePlayer()
    // })



    //    "noPossibleTurnLeft"
    //    "hasToPlayKnight"
    //    "hasToTakeCard"
    //    "hasToTakeCardOrPlayKnight"
    //    "isAbleToPlayNormally"
    document.getElementById("player1Canvas").addEventListener('mousedown',function(event){ // MY EYEEY! AHHH!
        //TODO find a better place for this listener.
        if(activePlayer.isAi){return}
        if(activePlayer != player1){return}
        if(!isAllowedToPlayCard){return}
        if(dialogBoxActive){return}
        var canvas = document.getElementById("player1Canvas")//FIXME Detect when game has ended or one player is unable to play, so he has to pass.
        var index = getClickedCardIndex(canvas)
        var msg = player1.playCard(index,board,deck,useKnight)
        if(msg != true){tempAlert(msg,2000); return}
        useKnight = false
        changeActivePlayer()
    })

    document.getElementById("player2Canvas").addEventListener('mousedown',function(event){
        //TODO find a better place for this listener.
        if(activePlayer.isAi){return}
        if(activePlayer != player2){return}
        if(!isAllowedToPlayCard){return}
        if(dialogBoxActive){return}
        var canvas = document.getElementById("player2Canvas")//!!! FIXME Detect when game has ended or one player is unable to play, so he has to pass.
        var index = getClickedCardIndex(canvas)
        var msg = player2.playCard(index,board,deck,useKnight)
        if(msg != true){tempAlert(msg,2000); return}
        useKnight = false
        changeActivePlayer()
    })

    document.getElementById("player1KnightCanvas").addEventListener('mousedown',function(event){
        //TODO find a better place for this listener.
        if(activePlayer.isAi){return}
        if(activePlayer != player1){return}
        if(dialogBoxActive){return}
        if(player1.knightCount< 1){
            tempAlert("No knights left!")
            return
        }

        if(useKnight == true){
            useKnight = false
            tempAlert("Use of knight deselected")
            return
        }//FIXME TODO FIXME ACUTUALLY IMPORTANT READ AND DO THIS !!! add a visual indication when useKnight is true
        tempAlert("Click the card to be used with the knight (covering a part of the board...",/* is a stupid idea for telling somebody to make a game decision based on the state of named board. With this text added it is probably the full board. LOL.)",*/2000)
        useKnight = true
    })

    document.getElementById("player2KnightCanvas").addEventListener('mousedown',function(event){
        //TODO find a better place for this listener.
        if(activePlayer.isAi){return}
        if(activePlayer != player2){return}
        if(dialogBoxActive){return}
        if(player2.knightCount< 1){
            tempAlert("No knights left!")
            return
        }
        if(useKnight == true){
            useKnight = false
            tempAlert("Use of knight deselected")
            return
        }//FIXME TODO FIXME ACUTUALLY IMPORTANT READ AND DO THIS !!! add a visual indication when useKnight is true
        tempAlert("Click the card to be used with the knight (covering a part of the board...",/* is a stupid idea for telling somebody to make a game decision based on the state of named board. With this text added it is probably the full board. LOL.)",*/2000)
        useKnight = true

    })

    document.getElementById("leftPanel").addEventListener('mousedown',function(){
        if(activePlayer.isAi){return}
        if(activePlayer != player1){return}
        //if(dialogBoxActive){return}
        var msg = player1.addCard(deck)
        if(msg === true)
        {
            setTimeout(function(){
                changeActivePlayer()
            } ,50)
        }else{tempAlert(msg,2000)}
    })

    document.getElementById("leftPanel").addEventListener('mousedown',function(){
        if(activePlayer.isAi){return}
        if(activePlayer != player2){return}
        if(dialogBoxActive){return}
        var msg = player2.addCard(deck)
        if(msg === true)
        {
            setTimeout(function(){
                changeActivePlayer()//else both player's events might get triggered with only one click.
            },50)
        }else{tempAlert(msg,2000)}
    })

    </script>

</body>
</html>
